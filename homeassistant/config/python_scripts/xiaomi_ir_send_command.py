"""
Xiaomi IR Send Command Python Script
This script sends IR commands directly to the Xiaomi device without authentication
"""

import socket
import struct
import time
import logging

# Set up logging
logger = logging.getLogger(__name__)

def xiaomi_ir_send_command(hass, command):
    """Send IR command to Xiaomi device"""
    
    # Get the device IP from secrets
    host = hass.states.get('input_text.xiaomi_ir_host')
    if host:
        device_ip = host.state
    else:
        # Default IP if not set
        device_ip = "192.168.68.62"
    
    logger.info(f"Sending IR command '{command}' to {device_ip}")
    
    try:
        # Create UDP socket
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.settimeout(5)
        
        # Map commands to IR codes
        ir_codes = {
            'hisense_tv_power': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01',
            'hisense_tv_volume_up': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02',
            'hisense_tv_volume_down': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03',
            'hisense_tv_channel_up': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04',
            'hisense_tv_channel_down': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05',
            'hisense_tv_input': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06',
            'hisense_tv_menu': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07',
            'hisense_tv_back': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08',
            'hisense_tv_ok': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x09',
            'hisense_tv_up': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0a',
            'hisense_tv_down': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0b',
            'hisense_tv_left': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c',
            'hisense_tv_right': b'\x21\x31\x00\x20\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0d'
        }
        
        # Send the command
        if command in ir_codes:
            sock.sendto(ir_codes[command], (device_ip, 54321))
            logger.info(f"Sent IR command: {command}")
            
            # Try to get response
            try:
                data, addr = sock.recvfrom(1024)
                logger.info(f"Received response from {addr}: {data.hex()}")
            except socket.timeout:
                logger.info("No response from device (this is normal)")
        else:
            logger.warning(f"Unknown command: {command}")
        
        sock.close()
        logger.info("IR command sent successfully")
        
    except Exception as e:
        logger.error(f"Error sending IR command: {e}")
        raise
